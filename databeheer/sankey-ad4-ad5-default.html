<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="utf-8" />
<title>Sankey AD4 → AD5 Mapping</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

<style>
body {
    margin:0;
    font-family:"Inter",sans-serif;
    background:#f8f8f8;
}
#topbar { background:#003b6c; height:8px; width:100%; }
#header {
    background:white;
    padding:25px 40px;
    border-bottom:1px solid #ddd;
}
#header h1 {
    margin:0;
    font-size:26px;
    font-weight:600;
    color:#003b6c;
}
#header p { margin:4px 0 0; color:#555; }

#tabs {
    padding:10px 40px;
    background:white;
    border-bottom:1px solid #ddd;
    display:flex;
    flex-wrap:wrap;
    gap:8px;
}
.tabbtn {
    padding:6px 12px;
    border-radius:4px;
    border:1px solid #bbb;
    background:#f2f2f2;
    cursor:pointer;
}
.tabbtn.active {
    background:#003b6c;
    color:white;
    border-color:#003b6c;
}

#chart { padding:20px; }
.tabcontent { display:none; }
.tabcontent.active { display:block; }

svg { background:white; }

.node rect { fill-opacity:0.9; }
.node text {
    pointer-events:none;
    font-size:12px;
    fill:#333;
    font-weight:600;
}
.link {
    fill:none;
    stroke-opacity:0.3;
}
</style>
</head>

<body>

<div id="topbar"></div>

<div id="header">
    <h1>Areaaldata 4 → Areaaldata 5 (IMBOR) – standaard</h1>
    <p>Per assetgroep gescheiden Sankey-weergave (stabiele variant)</p>
</div>

<div id="tabs"></div>
<div id="chart"></div>

<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="lib/d3-sankey.min.js"></script>

<script>
var width = 1600;
var height = 7430;
var margin = {top:20, right:50, bottom:20, left:200};

/* vaste basiskleuren per assetgroep */
const assetColors = {
    "bodem":"#8B5A2B",
    "groen":"#2E8B57",
    "wegen":"#7F7F7F",
    "vaarwegen":"#1F77B4",
    "kunstwerken":"#D62728",
    "ovl":"#F28C28",
    "integraal":"#E377C2",
    "wegkantsystemen":"#7A3EB1",
    "default":"#999999"
};

function shadeColor(base, factor) {
    const c = d3.color(base);
    return c ? (factor >= 0 ? c.brighter(1+factor) : c.darker(1-factor)) : base;
}

/* CSV inlezen en groeperen per assetgroep */
d3.csv("mapping-ad4-ad5-default.csv").then(data => {

    data.forEach(d => {
        const p = d.target.split(".");
        d.assetgroep = (p[1] || "default").toLowerCase();
    });

    const groups = d3.nest()
        .key(d => d.assetgroep)
        .entries(data)
        .sort((a,b)=>a.key.localeCompare(b.key,"nl"));

    /* tabs aanmaken */
    groups.forEach((g,i)=>{
        const btn = document.createElement("button");
        btn.className = "tabbtn" + (i===0?" active":"");
        btn.textContent = g.key;
        btn.dataset.tab = g.key;
        document.getElementById("tabs").appendChild(btn);

        const div = document.createElement("div");
        div.className = "tabcontent" + (i===0?" active":"");
        div.id = "tab-"+g.key;

        const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
        svg.setAttribute("id","sankey-"+g.key);
        div.appendChild(svg);

        document.getElementById("chart").appendChild(div);
    });

    /* tab switching */
    document.querySelectorAll(".tabbtn").forEach(btn=>{
        btn.onclick=()=>{
            document.querySelectorAll(".tabbtn").forEach(b=>b.classList.remove("active"));
            document.querySelectorAll(".tabcontent").forEach(c=>c.classList.remove("active"));
            btn.classList.add("active");
            document.getElementById("tab-"+btn.dataset.tab).classList.add("active");
        };
    });

    /* sankey per assetgroep tekenen */
    groups.forEach(g => drawSankey("#sankey-"+g.key, g.values, g.key));
});

function drawSankey(svgId, rows, assetgroep) {

    const svg = d3.select(svgId)
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom);

    svg.selectAll("*").remove();

    const container = svg.append("g")
        .attr("transform","translate("+margin.left+","+margin.top+")");

    const names = Array.from(new Set(rows.flatMap(d=>[d.source,d.target])));

    const graph = {
        nodes: names.map(n=>({name:n})),
        links: rows.map(d=>({
            source:names.indexOf(d.source),
            target:names.indexOf(d.target),
            value:+d.value||1,
            mapping:d.mapping||""
        }))
    };

    const sankey = d3.sankey()
        .nodeWidth(70)
        .nodePadding(18)
        .extent([[0,0],[width,height]]);

    sankey(graph);

    const baseColor = assetColors[assetgroep] || assetColors.default;

    /* links */
    container.append("g")
        .selectAll(".link")
        .data(graph.links)
        .enter().append("path")
        .attr("class","link")
        .attr("d",d3.sankeyLinkHorizontal())
        .style("stroke-width",d=>Math.max(1,d.width))
        .style("stroke",baseColor);

    /* nodes */
    const bySide = { left:[], right:[] };
    graph.nodes.forEach(n=>{
        (n.x0 < width/2 ? bySide.left : bySide.right).push(n);
    });

    [...bySide.left, ...bySide.right].forEach((n,i,arr)=>{
        n.shade = arr.length>1 ? (i/(arr.length-1)-0.5)*0.6 : 0;
    });

    const node = container.append("g")
        .selectAll(".node")
        .data(graph.nodes)
        .enter().append("g")
        .attr("class","node")
        .attr("transform",d=>"translate("+d.x0+","+d.y0+")");

    node.append("rect")
        .attr("height",d=>d.y1-d.y0)
        .attr("width",70)
        .style("fill",d=>shadeColor(baseColor,d.shade));

    node.append("text")
        .attr("x",-15)
        .attr("y",d=>(d.y1-d.y0)/2)
        .attr("dy","0.35em")
        .attr("text-anchor","end")
        .text(d=>d.name);
}
</script>

</body>
</html>