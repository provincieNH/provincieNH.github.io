<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="utf-8"/>

<title>Sankey AD4 → AD5</title>

<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="lib/d3-sankey.min.js"></script>

<style>
body { margin:0; font-family:Arial, sans-serif; background:#f8f8f8; }
#topbar { height:8px; background:#003b6c; }

#header {
    background:white;
    padding:20px 40px;
    border-bottom:1px solid #ddd;
}
#tabs {
    background:white;
    padding:10px 40px;
    display:flex;
    gap:10px;
    border-bottom:1px solid #ddd;
}
button {
    padding:6px 12px;
    border:1px solid #bbb;
    background:#f2f2f2;
    cursor:pointer;
}
button.active {
    background:#003b6c;
    color:white;
    border-color:#003b6c;
}

#chart { padding:20px; }

svg { background:white; }

.node rect { fill-opacity:0.9; }
.node text {
    font-size:12px;
    font-weight:600;
    pointer-events:none;
}
.link {
    fill:none;
    stroke-opacity:0.35;
}
</style>
</head>

<body>

<div id="topbar"></div>
<div id="header">
    <h2>Areaaldata 4 → Areaaldata 5</h2>
</div>

<div id="tabs">
    <button class="active" data-tab="ad5">AD5 – per assetgroep</button>
    <button data-tab="ad4">AD4 – per assetgroep</button>
    <button data-tab="orig">Origineel (CSV‑volgorde)</button>
</div>

<div id="chart">
    <svg id="svg_ad5"></svg>
    <svg id="svg_ad4" style="display:none"></svg>
    <svg id="svg_orig" style="display:none"></svg>
</div>

<script>
const width = 1800;
const height = 7430;
const margin = {top:20, right:260, bottom:20, left:260};

const assetColors = {
    "Bodem":"#8B5A2B",
    "Groen":"#2E8B57",
    "Wegkantsystemen":"#7A3EB1",
    "OVL/VRI":"#F28C28",
    "Integraal":"#E377C2",
    "Wegen":"#7F7F7F",
    "Vaarwegen":"#1F77B4",
    "Kunstwerken":"#D62728"
};

function draw(svgId, csv, mode) {

    const svg = d3.select(svgId)
        .attr("width",width + margin.left + margin.right)
        .attr("height",height + margin.top + margin.bottom);
    svg.selectAll("*").remove();

    const g = svg.append("g")
        .attr("transform",`translate(${margin.left},${margin.top})`);

    d3.csv(csv).then(data => {

        const nodes = [];
        const nodeMap = {};

        data.forEach(d => {
            if (!nodeMap[d.source]) {
                nodeMap[d.source] = {name:d.source, x:0, level:0};
            }
            if (!nodeMap[d.target]) {
                nodeMap[d.target] = {
                    name:d.target,
                    x:1,
                    level:1,
                    assetgroep: mode==="orig" ? null : d.assetgroep
                };
            }
        });

        Object.values(nodeMap).forEach(n => nodes.push(n));

        const links = data.map(d => ({
            source: nodes.findIndex(n=>n.name===d.source),
            target: nodes.findIndex(n=>n.name===d.target),
            value:+d.value || 1
        }));

        /* sortering */
        if (mode !== "orig") {
            nodes.sort((a,b)=>{
                if (a.x !== b.x) return a.x - b.x;
                if (mode==="ad5" && a.level===1 && a.assetgroep!==b.assetgroep)
                    return (a.assetgroep||"").localeCompare(b.assetgroep||"","nl");
                return a.name.localeCompare(b.name,"nl");
            });
        }

        const sankey = d3.sankey()
            .nodeWidth(70)
            .nodePadding(18)
            .nodeAlign(d=>d.x)
            .extent([[0,0],[width,height]]);

        sankey({nodes,links});

        /* links */
        g.append("g").selectAll(".link")
            .data(links)
            .enter().append("path")
            .attr("class","link")
            .attr("d",d3.sankeyLinkHorizontal())
            .style("stroke-width",d=>Math.max(1,d.width))
            .style("stroke",d=>{
                const ag = nodes[d.target.index].assetgroep;
                return assetColors[ag] || "#999";
            });

        /* nodes */
        const node = g.append("g").selectAll(".node")
            .data(nodes)
            .enter().append("g")
            .attr("class","node")
            .attr("transform",d=>`translate(${d.x0},${d.y0})`);

        node.append("rect")
            .attr("width",70)
            .attr("height",d=>d.y1-d.y0)
            .style("fill",d=>{
                if (d.level===0) return "#e0e0e0";
                return assetColors[d.assetgroep] || "#bbb";
            });

        node.append("text")
            .attr("x",-10)
            .attr("y",d=>(d.y1-d.y0)/2)
            .attr("dy","0.35em")
            .attr("text-anchor","end")
            .text(d=>d.name);
    });
}

/* tabs */
document.querySelectorAll("button").forEach(b=>{
    b.onclick=()=>{
        document.querySelectorAll("button").forEach(x=>x.classList.remove("active"));
        document.querySelectorAll("svg").forEach(s=>s.style.display="none");
        b.classList.add("active");
        document.getElementById("svg_"+b.dataset.tab).style.display="block";
    };
});

/* init */
draw("#svg_ad5","mapping-ad4-ad5-sort-ad5.csv","ad5");
draw("#svg_ad4","mapping-ad4-ad5-sort-ad4.csv","ad4");
draw("#svg_orig","mapping-ad4-ad5-sort-ad5.csv","orig");
</script>

</body>
</html>