<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="utf-8" />
<title>Sankey AD4 → AD5 Mapping</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

<style>
    body {
        margin:0;
        font-family: "Inter", sans-serif;
        background:#f8f8f8;
    }
    #topbar { background:#003b6c; height:8px; width:100%; }
    #header {
        background:white; padding:25px 40px;
        border-bottom:1px solid #ddd;
    }
    #header h1 { margin:0; font-size:26px; font-weight:600; color:#003b6c; }
    #header p { margin:4px 0 0; color:#555; }
    #filterbox { padding:15px 40px; background:white; border-bottom:1px solid #e0e0e0; }
    #filterbox input {
        width:350px; padding:8px 12px;
        border-radius:6px; border:1px solid #bbb;
    }
    #chart { padding:20px; }

    .node rect {
        cursor: move;
        fill-opacity: 0.9;
        shape-rendering: crispEdges;
    }
    .node text {
        pointer-events:none;
        font-size:13px;
        fill:#333;
        font-weight: 600;
    }
    .link {
        fill: none;
        stroke-opacity: 0.3;
    }
    .link:hover {
        stroke-opacity: 0.6;
    }
</style>
</head>

<body>
<div id="topbar"></div>

<div id="header">
    <h1>Areaaldata 4 → Areaaldata 5 (IMBOR) - Volledige Mapping</h1>
    <p>Interactieve Sankey-weergave met filtering, zoom en panning</p>
</div>

<div id="filterbox">
    <input id="filterInput" placeholder="Zoek in AD4 of AD5…" />
</div>

<div id="chart">
    <svg id="sankey_svg"></svg>
</div>

<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="lib/d3-sankey.min.js"></script>

<script>
var CSV_PATH = "mapping-ad4-ad5-alles.csv";   // Wordt vervangen door python script
var width = 1600;
var height = 3440;    // Wordt vervangen door python script

var margin = {top:20, right:50, bottom:20, left:50};

var svg = d3.select("#sankey_svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform","translate(" + margin.left + "," + margin.top + ")");

var sankey = d3.sankey()
    .nodeWidth(70)
    .nodePadding(18)
    .size([width, height]);

var color = d3.scaleOrdinal(d3.schemeCategory10);

d3.csv(CSV_PATH).then(function(data) {

    // Nodes uit data afleiden
    const nodeNames = Array.from(new Set(
        data.flatMap(d => [d.source, d.target])
    ));

    // Optionele debug: waarschuwingen voor ongeldige nodes in links
    data.forEach(d => {
        let s = nodeNames.indexOf(d.source);
        let t = nodeNames.indexOf(d.target);
        if (s < 0 || t < 0) {
            console.warn("Link verwijst naar onbekende node:", d.source, d.target);
        }
    });

    // Mapping data naar node indices, alleen geldige links mee nemen
    const graph = {
        nodes: nodeNames.map(n => ({ name: n })),
        links: data
            .map(d => ({
                source: nodeNames.indexOf(d.source),
                target: nodeNames.indexOf(d.target),
                value: +d.value || 1,
                mapping: d.mapping || ""
            }))
            .filter(link => link.source >= 0 && link.target >= 0)
    };

    sankey(graph);

    // Links tekenen
    svg.append("g").selectAll(".link")
        .data(graph.links)
        .enter()
        .append("path")
        .attr("class", "link")
        .attr("d", d3.sankeyLinkHorizontal())
        .style("stroke", d => {
            // d.target is nu een node object
            const nodeName = d.target.name;
            const parts = nodeName.split(".");
            return color(parts.length > 1 ? parts[1] : "default");
        })
        .style("stroke-width", d => Math.max(1, d.width || d.dy || 1))
        .append("title")
        .text(d => d.mapping);

    // Nodes tekenen
    const node = svg.append("g")
        .selectAll(".node")
        .data(graph.nodes)
        .enter()
        .append("g")
        .attr("class", "node")
        .attr("transform", d => "translate(" + (d.x0 || 0) + "," + (d.y0 || 0) + ")");

    node.append("rect")
        .attr("height", d => Math.max(4, (d.y1 || 0) - (d.y0 || 0)))
        .attr("width", sankey.nodeWidth())
        .style("fill", d => {
            const parts = d.name.split(".");
            return color(parts.length > 1 ? parts[1] : "default");
        })
        .append("title")
        .text(d => d.name);

    // Tekst linkse labels buiten de node voor beter leesbaarheid
    node.append("text")
        .attr("x", -15)
        .attr("y", d => ((d.y1 || 0) - (d.y0 || 0)) / 2)
        .attr("dy", "0.35em")
        .attr("text-anchor", "end")
        .style("font-size", "12px")
        .text(d => d.name);

    // Zoom en pan op svg g groep
    var zoom = d3.zoom()
        .scaleExtent([0.5, 5])
        .on("zoom", function(event){
            svg.attr("transform", event.transform);
        });

    d3.select("#sankey_svg")
        .call(zoom);

    // Filter functionaliteit
    document.getElementById("filterInput").addEventListener("input", function(e) {
        var q = e.target.value.toLowerCase();
        node.style("opacity", d => (d.name || "").toLowerCase().includes(q) ? 1 : 0.15);
        svg.selectAll(".link").style("opacity", l =>
            ((l.source && l.source.name || "").toLowerCase().includes(q)) ||
            ((l.target && l.target.name || "").toLowerCase().includes(q))
            ? 0.5 : 0.05
        );
    });

}).catch(err => {
    console.error("Fout bij laden CSV:", err);
});
</script>

</body>
</html>