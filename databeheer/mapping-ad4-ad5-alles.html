<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="utf-8" />

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

<style>
    body {
        margin: 0;
        font-family: "Inter", sans-serif;
        background: #f8f8f8;
    }
    #topbar { background: #003b6c; height: 8px; width: 100%; }
    #header { background: white; padding: 25px 40px; border-bottom: 1px solid #ddd; }
    #header h1 { margin: 0; font-size: 26px; font-weight: 600; color: #003b6c; }
    #header p { margin: 4px 0 0; color: #555; }
    #filterbox { padding: 15px 40px; background: white; border-bottom: 1px solid #e0e0e0; }
    #filterbox input { width: 350px; padding: 8px 12px; border-radius: 6px; border: 1px solid #bbb; }
    #chart { padding: 20px; }
    .node rect { cursor: move; fill-opacity: .9; }
    .node text { pointer-events: none; font-size: 13px; }
    .link { fill: none; stroke-opacity: .3; }
    .link:hover { stroke-opacity: .6; }
</style>

</head>
<body>

<div id="topbar"></div>

<div id="header">
    <h1>Areaaldata 4 → Areaaldata 5 (IMBOR) - Volledige Mapping</h1>
    <p>Interactieve Sankey-weergave met filtering, zoom en panning</p>
</div>

<div id="filterbox">
    <input id="filterInput" placeholder="Zoek in AD4 of AD5…" />
</div>

<div id="chart">
    <svg id="sankey_svg"></svg>
</div>

<!-- D3 V5 -->
<script src="https://d3js.org/d3.v5.min.js"></script>

<!-- LOKAAL: d3-sankey.min.js -->
<script src="lib/d3-sankey.min.js"></script>

<script>
var CSV_NAME = "databeheer/mapping-ad4-ad5-alles.csv";
var DIAG_HEIGHT = 1720;
var DIAG_SORTING = 10;

// Afmetingen
var margin = {top: 20, right: 50, bottom: 20, left: 50};
var width = 1600 - margin.left - margin.right;
var height = DIAG_HEIGHT;

// SVG + groep voor inhoud + zoom
var svg = d3.select("#sankey_svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform","translate(" + margin.left + "," + margin.top + ")");

var sankey = d3.sankey()
    .nodeWidth(22)
    .nodePadding(18)
    .size([width, height]);

var color = d3.scaleOrdinal(d3.schemeCategory10);

d3.csv(CSV_NAME).then(function(data) {

    const nodeNames = Array.from(new Set(
        data.flatMap(d => [d.source, d.target])
    ));

    const graph = {
        nodes: nodeNames.map(n => ({ name: n })),
        links: data.map(d => ({
            source: nodeNames.indexOf(d.source),
            target: nodeNames.indexOf(d.target),
            value: +d.value || 1,
            mapping: d.mapping || ""
        }))
    };

    sankey(graph);

    // Links tekenen
    svg.append("g").selectAll(".link")
        .data(graph.links)
        .enter()
        .append("path")
        .attr("class", "link")
        .attr("d", d3.sankeyLinkHorizontal())
        .style("stroke", d => {
            const node = (d.target && d.target.name) ? d.target : graph.nodes[d.target] || {};
            const parts = (node.name || "").split(".");
            return color(parts.length > 1 ? parts[1] : "default");
        })
        .style("stroke-width", d => Math.max(1, d.width || d.dy || 1))
        .append("title")
        .text(d => d.mapping);

    // Nodes tekenen
    var node = svg.append("g")
        .selectAll(".node")
        .data(graph.nodes)
        .enter()
        .append("g")
        .attr("class", "node")
        .attr("transform", d => "translate(" + (d.x0 || 0) + "," + (d.y0 || 0) + ")");

    node.append("rect")
        .attr("height", d => Math.max(4, (d.y1 || 0) - (d.y0 || 0)))
        .attr("width", sankey.nodeWidth())
        .style("fill", d => {
            const parts = (d.name || "").split(".");
            return color(parts.length > 1 ? parts[1] : "default");
        })
        .append("title")
        .text(d => d.name);

    node.append("text")
        .attr("x", -6)
        .attr("y", d => ((d.y1 || 0) - (d.y0 || 0)) / 2)
        .attr("dy", "0.35em")
        .attr("text-anchor", "end")
        .text(d => d.name);

    // Zoom functie toepassen op <g> in svg
    var zoom = d3.zoom()
        .scaleExtent([0.5, 5])
        .on("zoom", function(event) {
            svg.attr("transform", event.transform);
        });

    d3.select("#sankey_svg")
        .call(zoom);

    // Filtering
    document.getElementById("filterInput").addEventListener("input", function(e) {
        var q = e.target.value.toLowerCase();
        node.style("opacity", d => (d.name || "").toLowerCase().includes(q) ? 1 : 0.15);
        svg.selectAll(".link").style("opacity", l =>
            ((graph.nodes[l.source] && graph.nodes[l.source].name || "").toLowerCase().includes(q)) ||
            ((graph.nodes[l.target] && graph.nodes[l.target].name || "").toLowerCase().includes(q))
            ? 0.5 : 0.05
        );
    });

}).catch(error => {
    console.error("CSV laden mislukt:", error);
});
</script>

</body>
</html>