<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="utf-8"/>
<title>Sankey AD4 → AD5</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

<style>
body {
    margin:0;
    font-family:"Inter",sans-serif;
    background:#f8f8f8;
}

#topbar { background:#003b6c; height:8px; }

#header {
    background:white;
    padding:25px 40px;
    border-bottom:1px solid #ddd;
}
#header h1 {
    margin:0;
    font-size:26px;
    font-weight:600;
    color:#003b6c;
}
#header p {
    margin:4px 0 0;
    color:#555;
}

#filterbox {
    padding:15px 40px;
    background:white;
    border-bottom:1px solid #e0e0e0;
    display:flex;
    gap:10px;
    align-items:center;
}
#filterbox input {
    width:350px;
    padding:8px 12px;
    border-radius:6px;
    border:1px solid #bbb;
}
#filterbox button {
    padding:8px 14px;
    border-radius:6px;
    border:1px solid #bbb;
    background:#f2f2f2;
    cursor:pointer;
}

#tabs {
    padding:10px 40px;
    background:white;
    border-bottom:1px solid #ddd;
    display:flex;
    gap:8px;
}
.tabbtn {
    padding:6px 12px;
    border-radius:4px;
    border:1px solid #bbb;
    background:#f2f2f2;
    cursor:pointer;
}
.tabbtn.active {
    background:#003b6c;
    color:white;
    border-color:#003b6c;
}

#chart { padding:20px; }
.tabcontent { display:none; }
.tabcontent.active { display:block; }

svg { cursor:move; background:white; }

.node rect {
    fill-opacity:0.9;
    shape-rendering:crispEdges;
}
.node text {
    pointer-events:none;
    font-size:12px;
    fill:#333;
    font-weight:600;
}

.link {
    fill:none;
    stroke-opacity:0.35;
}

@media print {
    @page { size:landscape; margin:10mm; }
    body * { visibility:hidden; }
    #chart, #chart * { visibility:visible; }
    #chart {
        position:absolute;
        left:0; top:0;
        width:100%;
    }
    #filterbox button, #tabs { display:none; }
    svg { width:100%!important; height:auto!important; }
}
</style>
</head>

<body>

<div id="topbar"></div>

<div id="header">
    <h1>Areaaldata 4 → Areaaldata 5 (IMBOR) – gesorteerd op AD5-object</h1>
    <p>Gesorteerd overzicht met clustering en kleurschakering per assetgroep</p>
</div>

<div id="filterbox">
    <input id="filterInput" placeholder="Zoek in AD4 of AD5…"/>
    <button onclick="window.print()">Exporteer als PDF</button>
</div>

<div id="tabs">
    <button class="tabbtn active" data-tab="tab-ad5">Gesorteerd op AD5</button>
    <button class="tabbtn" data-tab="tab-ad4">Gesorteerd op AD4</button>
</div>

<div id="chart">
    <div id="tab-ad5" class="tabcontent active">
        <svg id="sankey_ad5"></svg>
    </div>
    <div id="tab-ad4" class="tabcontent">
        <svg id="sankey_ad4"></svg>
    </div>
</div>

<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="lib/d3-sankey.min.js"></script>

<script>
var width = 1600;
var height = 7430;
var margin = {top:20, right:70, bottom:20, left:200};

/* ================= Assetgroep kleuren ================= */

var assetColorMap = {
    "Bodem": "#8B5A2B",
    "Groen": "#2E8B57",
    "Wegkantsystemen": "#7A3EB1",
    "OVL/VRI": "#F28C28",
    "Integraal": "#E377C2",
    "Wegen": "#7F7F7F",
    "Vaarwegen": "#1F77B4",
    "Kunstwerken": "#D62728",
    "Onbekend": "#BBBBBB"
};

function assetColor(assetgroep) {
    return assetColorMap[assetgroep] || assetColorMap["Onbekend"];
}

function shadeColor(baseColor, factor) {
    const c = d3.color(baseColor);
    if (!c) return baseColor;
    return factor >= 0
        ? c.brighter(1 + factor)
        : c.darker(1 - factor);
}

/* ================= Tabs ================= */

document.querySelectorAll(".tabbtn").forEach(btn => {
    btn.addEventListener("click", () => {
        document.querySelectorAll(".tabbtn").forEach(b => b.classList.remove("active"));
        document.querySelectorAll(".tabcontent").forEach(c => c.classList.remove("active"));
        btn.classList.add("active");
        document.getElementById(btn.dataset.tab).classList.add("active");
    });
});

/* ================= Sankey ================= */

function drawSankey(svgId, csvPath, labelSide) {

    var svg = d3.select(svgId)
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom);

    svg.selectAll("*").remove();

    var outer = svg.append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    var container = outer.append("g");

    var sankey = d3.sankey()
        .nodeWidth(70)
        .nodePadding(18)
        .extent([[0,0],[width,height]]);

    d3.csv(csvPath).then(function(data) {

        /* nodes + assetgroep */
        const nodeMap = {};
        data.forEach(d => {
            if (!nodeMap[d.source]) nodeMap[d.source] = { name:d.source, assetgroep:d.assetgroep };
            if (!nodeMap[d.target]) nodeMap[d.target] = { name:d.target, assetgroep:d.assetgroep };
        });

        const graph = {
            nodes: Object.values(nodeMap),
            links: data.map(d => ({
                source:d.source,
                target:d.target,
                value:+d.value || 1,
                mapping:d.mapping
            }))
        };

        graph.links.forEach(l => {
            l.source = graph.nodes.findIndex(n => n.name === l.source);
            l.target = graph.nodes.findIndex(n => n.name === l.target);
        });

        /* sortering: assetgroep → asset */
        graph.nodes.sort((a,b)=>{
            if (a.assetgroep !== b.assetgroep) {
                return (a.assetgroep||"").localeCompare(b.assetgroep||"","nl");
            }
            return a.name.localeCompare(b.name,"nl");
        });

        /* tint‑index per assetgroep */
        const byGroup = {};
        graph.nodes.forEach(n=>{
            if(!byGroup[n.assetgroep]) byGroup[n.assetgroep]=[];
            byGroup[n.assetgroep].push(n);
        });

        Object.values(byGroup).forEach(nodes=>{
            const cnt = nodes.length;
            nodes.forEach((n,i)=>{
                n.shadeFactor = cnt>1 ? (i/(cnt-1)-0.5)*0.8 : 0;
            });
        });

        sankey(graph);

        /* assetgroep labels */
        let last=null;
        graph.nodes.forEach(n=>{
            if(n.assetgroep!==last){
                const isLeft = labelSide==="left";
                const y=n.y0;

                container.append("line")
                    .attr("x1",isLeft?-190:0)
                    .attr("x2",isLeft?width:width+190)
                    .attr("y1",y).attr("y2",y)
                    .style("stroke","#ccc")
                    .style("stroke-dasharray","3,3");

                container.append("text")
                    .attr("x",isLeft?-195:width+195)
                    .attr("y",y+12)
                    .attr("text-anchor",isLeft?"end":"start")
                    .style("font-weight","600")
                    .style("fill",assetColor(n.assetgroep))
                    .text(n.assetgroep||"Onbekend");

                last=n.assetgroep;
            }
        });

        /* links */
        container.append("g")
            .selectAll(".link")
            .data(graph.links)
            .enter().append("path")
            .attr("class","link")
            .attr("d",d3.sankeyLinkHorizontal())
            .style("stroke-width",d=>Math.max(1,d.width))
            .style("stroke",d=>assetColor(graph.nodes[d.target.index].assetgroep));

        /* nodes */
        var node = container.append("g")
            .selectAll(".node")
            .data(graph.nodes)
            .enter().append("g")
            .attr("class","node")
            .attr("transform",d=>"translate("+d.x0+","+d.y0+")");

        node.append("rect")
            .attr("height",d=>d.y1-d.y0)
            .attr("width",sankey.nodeWidth())
            .style("fill",d=>shadeColor(assetColor(d.assetgroep),d.shadeFactor));

        node.append("text")
            .attr("x",-15)
            .attr("y",d=>(d.y1-d.y0)/2)
            .attr("dy","0.35em")
            .attr("text-anchor","end")
            .text(d=>d.name);
    });
}

/* ================= Aanroepen ================= */

drawSankey("#sankey_ad5","mapping-ad4-ad5-sort-ad5.csv","right");
drawSankey("#sankey_ad4","mapping-ad4-ad5-sort-ad4.csv","left");
</script>

</body>
</html>